<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin Core: TxRequestTracker Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bitcoin_logo_doxygen.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin Core<span id="projectnumber">&#160;22.99.0</span>
   </div>
   <div id="projectbrief">P2P Digital Currency</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="class_tx_request_tracker-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">TxRequestTracker Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Data structure to keep track of, and schedule, transaction downloads from peers.  
 <a href="class_tx_request_tracker.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="txrequest_8h_source.html">txrequest.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker_1_1_impl.html">Impl</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Actual implementation for <a class="el" href="class_tx_request_tracker.html" title="Data structure to keep track of, and schedule, transaction downloads from peers.">TxRequestTracker</a>'s data structure.  <a href="class_tx_request_tracker_1_1_impl.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a6ec8f050c9502ccda9c5121fd299c189"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a6ec8f050c9502ccda9c5121fd299c189">TxRequestTracker</a> (bool deterministic=false)</td></tr>
<tr class="memdesc:a6ec8f050c9502ccda9c5121fd299c189"><td class="mdescLeft">&#160;</td><td class="mdescRight">Construct a <a class="el" href="class_tx_request_tracker.html" title="Data structure to keep track of, and schedule, transaction downloads from peers.">TxRequestTracker</a>.  <a href="class_tx_request_tracker.html#a6ec8f050c9502ccda9c5121fd299c189">More...</a><br /></td></tr>
<tr class="separator:a6ec8f050c9502ccda9c5121fd299c189"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7da55d550779ac4d237452d1e4219e19"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a7da55d550779ac4d237452d1e4219e19">~TxRequestTracker</a> ()</td></tr>
<tr class="separator:a7da55d550779ac4d237452d1e4219e19"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1cf844023af7f9f084810253777910b5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a1cf844023af7f9f084810253777910b5">ReceivedInv</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer, const <a class="el" href="class_gen_txid.html">GenTxid</a> &amp;gtxid, bool preferred, std::chrono::microseconds reqtime)</td></tr>
<tr class="memdesc:a1cf844023af7f9f084810253777910b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Adds a new CANDIDATE announcement.  <a href="class_tx_request_tracker.html#a1cf844023af7f9f084810253777910b5">More...</a><br /></td></tr>
<tr class="separator:a1cf844023af7f9f084810253777910b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7bd634efd007f5f18c2f7854f758f78e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a7bd634efd007f5f18c2f7854f758f78e">DisconnectedPeer</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer)</td></tr>
<tr class="memdesc:a7bd634efd007f5f18c2f7854f758f78e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deletes all announcements for a given peer.  <a href="class_tx_request_tracker.html#a7bd634efd007f5f18c2f7854f758f78e">More...</a><br /></td></tr>
<tr class="separator:a7bd634efd007f5f18c2f7854f758f78e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef0dd72c13d0b2604b74a9b4ba442e38"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#aef0dd72c13d0b2604b74a9b4ba442e38">ForgetTxHash</a> (const <a class="el" href="classuint256.html">uint256</a> &amp;txhash)</td></tr>
<tr class="memdesc:aef0dd72c13d0b2604b74a9b4ba442e38"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deletes all announcements for a given txhash (both txid and wtxid ones).  <a href="class_tx_request_tracker.html#aef0dd72c13d0b2604b74a9b4ba442e38">More...</a><br /></td></tr>
<tr class="separator:aef0dd72c13d0b2604b74a9b4ba442e38"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adaf75e64a1eb6f6a7645faca3c7bf80b"><td class="memItemLeft" align="right" valign="top">std::vector&lt; <a class="el" href="class_gen_txid.html">GenTxid</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#adaf75e64a1eb6f6a7645faca3c7bf80b">GetRequestable</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer, std::chrono::microseconds now, std::vector&lt; std::pair&lt; <a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>, <a class="el" href="class_gen_txid.html">GenTxid</a> &gt; &gt; *expired=nullptr)</td></tr>
<tr class="memdesc:adaf75e64a1eb6f6a7645faca3c7bf80b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find the txids to request now from peer.  <a href="class_tx_request_tracker.html#adaf75e64a1eb6f6a7645faca3c7bf80b">More...</a><br /></td></tr>
<tr class="separator:adaf75e64a1eb6f6a7645faca3c7bf80b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f755ca623c90081232082b2968a3b6a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a9f755ca623c90081232082b2968a3b6a">RequestedTx</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer, const <a class="el" href="classuint256.html">uint256</a> &amp;txhash, std::chrono::microseconds expiry)</td></tr>
<tr class="memdesc:a9f755ca623c90081232082b2968a3b6a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Marks a transaction as requested, with a specified expiry.  <a href="class_tx_request_tracker.html#a9f755ca623c90081232082b2968a3b6a">More...</a><br /></td></tr>
<tr class="separator:a9f755ca623c90081232082b2968a3b6a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a852c3e2d50670c35059bb0510c3e60b3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a852c3e2d50670c35059bb0510c3e60b3">ReceivedResponse</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer, const <a class="el" href="classuint256.html">uint256</a> &amp;txhash)</td></tr>
<tr class="memdesc:a852c3e2d50670c35059bb0510c3e60b3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts a CANDIDATE or REQUESTED announcement to a COMPLETED one.  <a href="class_tx_request_tracker.html#a852c3e2d50670c35059bb0510c3e60b3">More...</a><br /></td></tr>
<tr class="separator:a852c3e2d50670c35059bb0510c3e60b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a293fe778af5d14dd62ad102a55b23c9c"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a293fe778af5d14dd62ad102a55b23c9c">CountInFlight</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer) const</td></tr>
<tr class="memdesc:a293fe778af5d14dd62ad102a55b23c9c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count how many REQUESTED announcements a peer has.  <a href="class_tx_request_tracker.html#a293fe778af5d14dd62ad102a55b23c9c">More...</a><br /></td></tr>
<tr class="separator:a293fe778af5d14dd62ad102a55b23c9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a44c02557f64498d97d132338bf97391f"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a44c02557f64498d97d132338bf97391f">CountCandidates</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer) const</td></tr>
<tr class="memdesc:a44c02557f64498d97d132338bf97391f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count how many CANDIDATE announcements a peer has.  <a href="class_tx_request_tracker.html#a44c02557f64498d97d132338bf97391f">More...</a><br /></td></tr>
<tr class="separator:a44c02557f64498d97d132338bf97391f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab33b9f7fdf1884bb9dc014ab8ea58001"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#ab33b9f7fdf1884bb9dc014ab8ea58001">Count</a> (<a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer) const</td></tr>
<tr class="memdesc:ab33b9f7fdf1884bb9dc014ab8ea58001"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count how many announcements a peer has (REQUESTED, CANDIDATE, and COMPLETED combined).  <a href="class_tx_request_tracker.html#ab33b9f7fdf1884bb9dc014ab8ea58001">More...</a><br /></td></tr>
<tr class="separator:ab33b9f7fdf1884bb9dc014ab8ea58001"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab9e017d8de83b40a31ee62276a735c28"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#ab9e017d8de83b40a31ee62276a735c28">Size</a> () const</td></tr>
<tr class="memdesc:ab9e017d8de83b40a31ee62276a735c28"><td class="mdescLeft">&#160;</td><td class="mdescRight">Count how many announcements are being tracked in total across all peers and transaction hashes.  <a href="class_tx_request_tracker.html#ab9e017d8de83b40a31ee62276a735c28">More...</a><br /></td></tr>
<tr class="separator:ab9e017d8de83b40a31ee62276a735c28"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ed47a0767c45e4df5938f6cf4951f13"><td class="memItemLeft" align="right" valign="top">uint64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a8ed47a0767c45e4df5938f6cf4951f13">ComputePriority</a> (const <a class="el" href="classuint256.html">uint256</a> &amp;txhash, <a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer, bool preferred) const</td></tr>
<tr class="memdesc:a8ed47a0767c45e4df5938f6cf4951f13"><td class="mdescLeft">&#160;</td><td class="mdescRight">Access to the internal priority computation (testing only)  <a href="class_tx_request_tracker.html#a8ed47a0767c45e4df5938f6cf4951f13">More...</a><br /></td></tr>
<tr class="separator:a8ed47a0767c45e4df5938f6cf4951f13"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22a581f4bd3d1332c92cde5e2a093042"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a22a581f4bd3d1332c92cde5e2a093042">SanityCheck</a> () const</td></tr>
<tr class="memdesc:a22a581f4bd3d1332c92cde5e2a093042"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run internal consistency check (testing only).  <a href="class_tx_request_tracker.html#a22a581f4bd3d1332c92cde5e2a093042">More...</a><br /></td></tr>
<tr class="separator:a22a581f4bd3d1332c92cde5e2a093042"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96b10286d98af5626ad0b11b9bce314d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a96b10286d98af5626ad0b11b9bce314d">PostGetRequestableSanityCheck</a> (std::chrono::microseconds now) const</td></tr>
<tr class="memdesc:a96b10286d98af5626ad0b11b9bce314d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run a time-dependent internal consistency check (testing only).  <a href="class_tx_request_tracker.html#a96b10286d98af5626ad0b11b9bce314d">More...</a><br /></td></tr>
<tr class="separator:a96b10286d98af5626ad0b11b9bce314d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a758173add4285b060191c9c5b8dc15ec"><td class="memItemLeft" align="right" valign="top">const std::unique_ptr&lt; <a class="el" href="class_tx_request_tracker_1_1_impl.html">Impl</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tx_request_tracker.html#a758173add4285b060191c9c5b8dc15ec">m_impl</a></td></tr>
<tr class="separator:a758173add4285b060191c9c5b8dc15ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >Data structure to keep track of, and schedule, transaction downloads from peers. </p>
<p >=== Specification ===</p>
<p >We keep track of which peers have announced which transactions, and use that to determine which requests should go to which peer, when, and in what order.</p>
<p >The following information is tracked per peer/tx combination ("announcement"):</p><ul>
<li>Which peer announced it (through their NodeId)</li>
<li>The txid or wtxid of the transaction (collectively called "txhash" in what follows)</li>
<li>Whether it was a tx or wtx announcement (see BIP339).</li>
<li>What the earliest permitted time is that that transaction can be requested from that peer (called "reqtime").</li>
<li>Whether it's from a "preferred" peer or not. Which announcements get this flag is determined by the caller, but this is designed for outbound peers, or other peers that we have a higher level of trust in. Even when the peers' preferredness changes, the preferred flag of existing announcements from that peer won't change.</li>
<li>Whether or not the transaction was requested already, and if so, when it times out (called "expiry").</li>
<li>Whether or not the transaction request failed already (timed out, or invalid transaction or NOTFOUND was received).</li>
</ul>
<p >Transaction requests are then assigned to peers, following these rules:</p>
<ul>
<li><p class="startli">No transaction is requested as long as another request for the same txhash is outstanding (it needs to fail first by passing expiry, or a NOTFOUND or invalid transaction has to be received for it).</p>
<p class="startli">Rationale: to avoid wasting bandwidth on multiple copies of the same transaction. Note that this only works per txhash, so if the same transaction is announced both through txid and wtxid, we have no means to prevent fetching both (the caller can however mitigate this by delaying one, see further).</p>
</li>
<li><p class="startli">The same transaction is never requested twice from the same peer, unless the announcement was forgotten in between, and re-announced. Announcements are forgotten only:</p><ul>
<li>If a peer goes offline, all its announcements are forgotten.</li>
<li>If a transaction has been successfully received, or is otherwise no longer needed, the caller can call ForgetTxHash, which removes all announcements across all peers with the specified txhash.</li>
<li>If for a given txhash only already-failed announcements remain, they are all forgotten.</li>
</ul>
<p class="startli">Rationale: giving a peer multiple chances to announce a transaction would allow them to bias requests in their favor, worsening transaction censoring attacks. The flip side is that as long as an attacker manages to prevent us from receiving a transaction, failed announcements (including those from honest peers) will linger longer, increasing memory usage somewhat. The impact of this is limited by imposing a cap on the number of tracked announcements per peer. As failed requests in response to announcements from honest peers should be rare, this almost solely hinders attackers. Transaction censoring attacks can be done by announcing transactions quickly while not answering requests for them. See <a href="https://allquantor.at/blockchainbib/pdf/miller2015topology.pdf">https://allquantor.at/blockchainbib/pdf/miller2015topology.pdf</a> for more information.</p>
</li>
<li><p class="startli">Transactions are not requested from a peer until its reqtime has passed.</p>
<p class="startli">Rationale: enable the calling code to define a delay for less-than-ideal peers, so that (presumed) better peers have a chance to give their announcement first.</p>
</li>
<li>If multiple viable candidate peers exist according to the above rules, pick a peer as follows:<ul>
<li><p class="startli">If any preferred peers are available, non-preferred peers are not considered for what follows.</p>
<p class="startli">Rationale: preferred peers are more trusted by us, so are less likely to be under attacker control.</p>
</li>
<li><p class="startli">Pick a uniformly random peer among the candidates.</p>
<p class="startli">Rationale: random assignments are hard to influence for attackers.</p>
</li>
</ul>
</li>
</ul>
<p >Together these rules strike a balance between being fast in non-adverserial conditions and minimizing susceptibility to censorship attacks. An attacker that races the network:</p><ul>
<li>Will be unsuccessful if all preferred connections are honest (and there is at least one preferred connection).</li>
<li>If there are P preferred connections of which Ph&gt;=1 are honest, the attacker can delay us from learning about a transaction by k expiration periods, where k ~ 1 + NHG(N=P-1,K=P-Ph-1,r=1), which has mean P/(Ph+1) (where NHG stands for Negative Hypergeometric distribution). The "1 +" is due to the fact that the attacker can be the first to announce through a preferred connection in this scenario, which very likely means they get the first request.</li>
<li>If all P preferred connections are to the attacker, and there are NP non-preferred connections of which NPh&gt;=1 are honest, where we assume that the attacker can disconnect and reconnect those connections, the distribution becomes k ~ P + NB(p=1-NPh/NP,r=1) (where NB stands for Negative Binomial distribution), which has mean P-1+NP/NPh.</li>
</ul>
<p >Complexity:</p><ul>
<li>Memory usage is proportional to the total number of tracked announcements (<a class="el" href="class_tx_request_tracker.html#ab9e017d8de83b40a31ee62276a735c28" title="Count how many announcements are being tracked in total across all peers and transaction hashes.">Size()</a>) plus the number of peers with a nonzero number of tracked announcements.</li>
<li>CPU usage is generally logarithmic in the total number of tracked announcements, plus the number of announcements affected by an operation (amortized O(1) per announcement). </li>
</ul>

<p class="definition">Definition at line <a class="el" href="txrequest_8h_source.html#l00096">96</a> of file <a class="el" href="txrequest_8h_source.html">txrequest.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a6ec8f050c9502ccda9c5121fd299c189" name="a6ec8f050c9502ccda9c5121fd299c189"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6ec8f050c9502ccda9c5121fd299c189">&#9670;&nbsp;</a></span>TxRequestTracker()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TxRequestTracker::TxRequestTracker </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>deterministic</em> = <code>false</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Construct a <a class="el" href="class_tx_request_tracker.html" title="Data structure to keep track of, and schedule, transaction downloads from peers.">TxRequestTracker</a>. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00712">712</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a7da55d550779ac4d237452d1e4219e19" name="a7da55d550779ac4d237452d1e4219e19"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7da55d550779ac4d237452d1e4219e19">&#9670;&nbsp;</a></span>~TxRequestTracker()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TxRequestTracker::~TxRequestTracker </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">default</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a8ed47a0767c45e4df5938f6cf4951f13" name="a8ed47a0767c45e4df5938f6cf4951f13"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ed47a0767c45e4df5938f6cf4951f13">&#9670;&nbsp;</a></span>ComputePriority()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint64_t TxRequestTracker::ComputePriority </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classuint256.html">uint256</a> &amp;&#160;</td>
          <td class="paramname"><em>txhash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>preferred</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Access to the internal priority computation (testing only) </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00752">752</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="ab33b9f7fdf1884bb9dc014ab8ea58001" name="ab33b9f7fdf1884bb9dc014ab8ea58001"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab33b9f7fdf1884bb9dc014ab8ea58001">&#9670;&nbsp;</a></span>Count()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t TxRequestTracker::Count </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Count how many announcements a peer has (REQUESTED, CANDIDATE, and COMPLETED combined). </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00721">721</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a44c02557f64498d97d132338bf97391f" name="a44c02557f64498d97d132338bf97391f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a44c02557f64498d97d132338bf97391f">&#9670;&nbsp;</a></span>CountCandidates()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t TxRequestTracker::CountCandidates </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Count how many CANDIDATE announcements a peer has. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00720">720</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a293fe778af5d14dd62ad102a55b23c9c" name="a293fe778af5d14dd62ad102a55b23c9c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a293fe778af5d14dd62ad102a55b23c9c">&#9670;&nbsp;</a></span>CountInFlight()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t TxRequestTracker::CountInFlight </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Count how many REQUESTED announcements a peer has. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00719">719</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a7bd634efd007f5f18c2f7854f758f78e" name="a7bd634efd007f5f18c2f7854f758f78e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7bd634efd007f5f18c2f7854f758f78e">&#9670;&nbsp;</a></span>DisconnectedPeer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::DisconnectedPeer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deletes all announcements for a given peer. </p>
<p >It should be called when a peer goes offline. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00718">718</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="aef0dd72c13d0b2604b74a9b4ba442e38" name="aef0dd72c13d0b2604b74a9b4ba442e38"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aef0dd72c13d0b2604b74a9b4ba442e38">&#9670;&nbsp;</a></span>ForgetTxHash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::ForgetTxHash </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classuint256.html">uint256</a> &amp;&#160;</td>
          <td class="paramname"><em>txhash</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deletes all announcements for a given txhash (both txid and wtxid ones). </p>
<p >This should be called when a transaction is no longer needed. The caller should ensure that new announcements for the same txhash will not trigger new ReceivedInv calls, at least in the short term after this call. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00717">717</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="adaf75e64a1eb6f6a7645faca3c7bf80b" name="adaf75e64a1eb6f6a7645faca3c7bf80b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adaf75e64a1eb6f6a7645faca3c7bf80b">&#9670;&nbsp;</a></span>GetRequestable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; <a class="el" href="class_gen_txid.html">GenTxid</a> &gt; TxRequestTracker::GetRequestable </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::chrono::microseconds&#160;</td>
          <td class="paramname"><em>now</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::pair&lt; <a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>, <a class="el" href="class_gen_txid.html">GenTxid</a> &gt; &gt; *&#160;</td>
          <td class="paramname"><em>expired</em> = <code>nullptr</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Find the txids to request now from peer. </p>
<p >It does the following:</p><ul>
<li>Convert all REQUESTED announcements (for all txhashes/peers) with (expiry &lt;= now) to COMPLETED ones. These are returned in expired, if non-nullptr.</li>
<li>Requestable announcements are selected: CANDIDATE announcements from the specified peer with (reqtime &lt;= now) for which no existing REQUESTED announcement with the same txhash from a different peer exists, and for which the specified peer is the best choice among all (reqtime &lt;= now) CANDIDATE announcements with the same txhash (subject to preferredness rules, and tiebreaking using a deterministic salted hash of peer and txhash).</li>
<li>The selected announcements are converted to GenTxids using their is_wtxid flag, and returned in announcement order (even if multiple were added at the same time, or when the clock went backwards while they were being added). This is done to minimize disruption from dependent transactions being requested out of order: if multiple dependent transactions are announced simultaneously by one peer, and end up being requested from them, the requests will happen in announcement order. </li>
</ul>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00746">746</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a96b10286d98af5626ad0b11b9bce314d" name="a96b10286d98af5626ad0b11b9bce314d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96b10286d98af5626ad0b11b9bce314d">&#9670;&nbsp;</a></span>PostGetRequestableSanityCheck()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::PostGetRequestableSanityCheck </td>
          <td>(</td>
          <td class="paramtype">std::chrono::microseconds&#160;</td>
          <td class="paramname"><em>now</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run a time-dependent internal consistency check (testing only). </p>
<p >This can only be called immediately after GetRequestable, with the same 'now' parameter. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00725">725</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a1cf844023af7f9f084810253777910b5" name="a1cf844023af7f9f084810253777910b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1cf844023af7f9f084810253777910b5">&#9670;&nbsp;</a></span>ReceivedInv()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::ReceivedInv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_gen_txid.html">GenTxid</a> &amp;&#160;</td>
          <td class="paramname"><em>gtxid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>preferred</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::chrono::microseconds&#160;</td>
          <td class="paramname"><em>reqtime</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Adds a new CANDIDATE announcement. </p>
<p >Does nothing if one already exists for that (txhash, peer) combination (whether it's CANDIDATE, REQUESTED, or COMPLETED). Note that the txid/wtxid property is ignored for determining uniqueness, so if an announcement is added for a wtxid H, while one for txid H from the same peer already exists, it will be ignored. This is harmless as the txhashes being equal implies it is a non-segwit transaction, so it doesn't matter how it is fetched. The new announcement is given the specified preferred and reqtime values, and takes its is_wtxid from the specified gtxid. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00730">730</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a852c3e2d50670c35059bb0510c3e60b3" name="a852c3e2d50670c35059bb0510c3e60b3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a852c3e2d50670c35059bb0510c3e60b3">&#9670;&nbsp;</a></span>ReceivedResponse()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::ReceivedResponse </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classuint256.html">uint256</a> &amp;&#160;</td>
          <td class="paramname"><em>txhash</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts a CANDIDATE or REQUESTED announcement to a COMPLETED one. </p>
<p >If no such announcement exists for the provided peer and txhash, nothing happens.</p>
<p >It should be called whenever a transaction or NOTFOUND was received from a peer. When the transaction is not needed entirely anymore, ForgetTxhash should be called instead of, or in addition to, this call. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00741">741</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a9f755ca623c90081232082b2968a3b6a" name="a9f755ca623c90081232082b2968a3b6a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f755ca623c90081232082b2968a3b6a">&#9670;&nbsp;</a></span>RequestedTx()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::RequestedTx </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&#160;</td>
          <td class="paramname"><em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="classuint256.html">uint256</a> &amp;&#160;</td>
          <td class="paramname"><em>txhash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::chrono::microseconds&#160;</td>
          <td class="paramname"><em>expiry</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Marks a transaction as requested, with a specified expiry. </p>
<p >If no CANDIDATE announcement for the provided peer and txhash exists, this call has no effect. Otherwise:</p><ul>
<li>That announcement is converted to REQUESTED.</li>
<li>If any other REQUESTED announcement for the same txhash already existed, it means an unexpected request was made (GetRequestable will never advise doing so). In this case it is converted to COMPLETED, as we're no longer waiting for a response to it. </li>
</ul>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00736">736</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="a22a581f4bd3d1332c92cde5e2a093042" name="a22a581f4bd3d1332c92cde5e2a093042"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22a581f4bd3d1332c92cde5e2a093042">&#9670;&nbsp;</a></span>SanityCheck()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TxRequestTracker::SanityCheck </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run internal consistency check (testing only). </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00723">723</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<a id="ab9e017d8de83b40a31ee62276a735c28" name="ab9e017d8de83b40a31ee62276a735c28"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab9e017d8de83b40a31ee62276a735c28">&#9670;&nbsp;</a></span>Size()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t TxRequestTracker::Size </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Count how many announcements are being tracked in total across all peers and transaction hashes. </p>

<p class="definition">Definition at line <a class="el" href="txrequest_8cpp_source.html#l00722">722</a> of file <a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a758173add4285b060191c9c5b8dc15ec" name="a758173add4285b060191c9c5b8dc15ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a758173add4285b060191c9c5b8dc15ec">&#9670;&nbsp;</a></span>m_impl</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const std::unique_ptr&lt;<a class="el" href="class_tx_request_tracker_1_1_impl.html">Impl</a>&gt; TxRequestTracker::m_impl</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="txrequest_8h_source.html#l00099">99</a> of file <a class="el" href="txrequest_8h_source.html">txrequest.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>src/<a class="el" href="txrequest_8h_source.html">txrequest.h</a></li>
<li>src/<a class="el" href="txrequest_8cpp_source.html">txrequest.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Nov 8 2021 14:20:12 for Bitcoin Core by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
